<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AgriBot | Smart Farming Assistant</title>
    <link href="https://cdn.jsdelivr.net/npm/@n8n/chat/dist/style.css" rel="stylesheet" />
    <link rel="stylesheet" href="style.css"> 
    <style>
        /* Floating Mic Button Style */
        .mic-button {
            position: fixed;
            bottom: 30px;
            right: 30px;
            width: 60px;
            height: 60px;
            background: #059669; /* Green */
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            color: white;
            font-size: 24px;
            border: none;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            cursor: pointer;
            z-index: 9999; /* On top of everything */
            transition: all 0.2s;
        }

        .mic-button:hover {
            transform: scale(1.1);
            background: #047857;
        }

        .mic-button.listening {
            background: #dc2626; /* Red when recording */
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(220, 38, 38, 0.7); }
            70% { box-shadow: 0 0 0 15px rgba(220, 38, 38, 0); }
            100% { box-shadow: 0 0 0 0 rgba(220, 38, 38, 0); }
        }
    </style>
</head>
<body>

    <div class="header">
        <h1>ðŸŒ± AgriBot</h1>
        <p>Your AI Assistant for Crop & Weather Advice</p>
    </div>

    <div id="n8n-chat"></div>

    <button id="mic-btn" class="mic-button" title="Speak to AgriBot">ðŸŽ¤</button>

    <script type="module">
        import { createChat } from 'https://cdn.jsdelivr.net/npm/@n8n/chat/dist/chat.bundle.es.js';

        // 1. Initialize the Chat
        createChat({
            webhookUrl: 'https://devanshkalrad.app.n8n.cloud/webhook/6ace38a3-7145-4c3a-b230-007b16dc998d/chat', // <--- PASTE YOUR N8N URL HERE
            target: '#n8n-chat',
            mode: 'fullscreen', 
            showWelcomeScreen: true,
            allowFileUploads: true, 
            initialMessages: [
                'Namaste! I am AgriBot. ðŸŒ¾',
                'Click the ðŸŽ¤ button to speak to me!'
            ],
            i18n: {
                en: {
                    title: 'AgriBot Chat',
                    subtitle: 'AI-Powered Assistant'
                }
            },
            style: {
                '--chat---color-primary': 'transparent',
                '--chat---color-secondary': 'transparent',
                '--chat---color-background': 'transparent'
            }
        });

        // --- 2. ADDING SPEECH CAPABILITIES ---

        // A. TEXT-TO-SPEECH (The Bot Speaks)
        const synth = window.speechSynthesis;
        
        // This watches the chat window for new messages
        const observer = new MutationObserver((mutations) => {
            mutations.forEach((mutation) => {
                mutation.addedNodes.forEach((node) => {
                    // Check if the new node is a bot message (chat-message-left)
                    // Note: Class names might vary, so we check the structure
                    if (node.nodeType === 1 && node.innerText && !node.classList.contains('chat-message-right')) {
                        
                        // Small delay to ensure text is ready
                        setTimeout(() => {
                            // Find the text content inside the message bubbles
                            // We filter out "Time" or "Name" text if possible
                            const text = node.innerText; 
                            
                            // Speak it!
                            if(text.length > 2) { // Avoid reading empty loading dots
                                const utterance = new SpeechSynthesisUtterance(text);
                                utterance.rate = 1; // Normal speed
                                utterance.pitch = 1;
                                // Try to find a Hindi/Indian English voice if available
                                const voices = synth.getVoices();
                                const indianVoice = voices.find(v => v.lang.includes('IN'));
                                if(indianVoice) utterance.voice = indianVoice;
                                
                                synth.cancel(); // Stop previous speech
                                synth.speak(utterance);
                            }
                        }, 500);
                    }
                });
            });
        });

        // Start watching the chat container after a short delay
        setTimeout(() => {
            const chatContainer = document.querySelector('#n8n-chat');
            if(chatContainer) {
                observer.observe(chatContainer, { childList: true, subtree: true });
            }
        }, 2000);


        // B. SPEECH-TO-TEXT (You Speak)
        const micBtn = document.getElementById('mic-btn');
        
        if ('webkitSpeechRecognition' in window) {
            const recognition = new webkitSpeechRecognition();
            recognition.continuous = false;
            recognition.lang = 'en-IN'; // Indian English
            recognition.interimResults = false;

            micBtn.addEventListener('click', () => {
                recognition.start();
                micBtn.classList.add('listening');
            });

            recognition.onresult = (event) => {
                micBtn.classList.remove('listening');
                const transcript = event.results[0][0].transcript;
                
                // Find the input box inside the n8n widget
                const chatInput = document.querySelector('textarea.chat-input') || document.querySelector('input.chat-input');
                const sendBtn = document.querySelector('button[aria-label="Send message"]') || document.querySelector('.chat-input-send-button');

                if (chatInput) {
                    // Type the text into the box
                    chatInput.value = transcript;
                    chatInput.dispatchEvent(new Event('input', { bubbles: true }));
                    
                    // Optional: Auto-click send
                    if(sendBtn) setTimeout(() => sendBtn.click(), 500);
                }
            };

            recognition.onerror = () => {
                micBtn.classList.remove('listening');
            };
            
            recognition.onend = () => {
                micBtn.classList.remove('listening');
            };
        } else {
            micBtn.style.display = 'none'; // Hide if browser doesn't support it
            console.log("Web Speech API not supported in this browser");
        }
    </script>
</body>
</html>



