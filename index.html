<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AgriBot | Smart Farming Assistant</title>
    <link href="https://cdn.jsdelivr.net/npm/@n8n/chat/dist/style.css" rel="stylesheet" />
    <link rel="stylesheet" href="style.css"> 
    <style>
        /* Floating Mic Button Style */
        .mic-button {
            position: fixed;
            bottom: 30px;
            right: 30px;
            width: 60px;
            height: 60px;
            background: #059669;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            color: white;
            font-size: 24px;
            border: none;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            cursor: pointer;
            z-index: 9999;
            transition: all 0.2s;
        }

        .mic-button:hover {
            transform: scale(1.1);
            background: #047857;
        }

        .mic-button.listening {
            background: #dc2626; /* Red when recording */
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(220, 38, 38, 0.7); }
            70% { box-shadow: 0 0 0 15px rgba(220, 38, 38, 0); }
            100% { box-shadow: 0 0 0 0 rgba(220, 38, 38, 0); }
        }
    </style>
</head>
<body>

    <div class="header">
        <h1>ðŸŒ± AgriBot</h1>
        <p>Your AI Assistant for Crop & Weather Advice</p>
    </div>

    <div id="n8n-chat"></div>

    <button id="mic-btn" class="mic-button" title="Speak to AgriBot">ðŸŽ¤</button>

    <script type="module">
        import { createChat } from 'https://cdn.jsdelivr.net/npm/@n8n/chat/dist/chat.bundle.es.js';

        createChat({
            webhookUrl: 'https://devanshkalrad.app.n8n.cloud/webhook/6ace38a3-7145-4c3a-b230-007b16dc998d/chat', // <--- PASTE YOUR N8N URL HERE
            target: '#n8n-chat',
            mode: 'fullscreen', 
            showWelcomeScreen: true,
            allowFileUploads: true, 
            initialMessages: [
                'Namaste! I am AgriBot. ðŸŒ¾',
                'Click the ðŸŽ¤ button to speak to me!'
            ],
            i18n: {
                en: {
                    title: 'AgriBot Chat',
                    subtitle: 'AI-Powered Assistant'
                }
            },
            style: {
                '--chat---color-primary': 'transparent',
                '--chat---color-secondary': 'transparent',
                '--chat---color-background': 'transparent'
            }
        });

        // --- SPEECH LOGIC ---
        
        // 1. TEXT-TO-SPEECH (Bot Speaks)
        const synth = window.speechSynthesis;
        const observer = new MutationObserver((mutations) => {
            mutations.forEach((mutation) => {
                mutation.addedNodes.forEach((node) => {
                    if (node.nodeType === 1 && node.innerText && !node.classList.contains('chat-message-right')) {
                        setTimeout(() => {
                            const text = node.innerText; 
                            if(text.length > 2) {
                                const utterance = new SpeechSynthesisUtterance(text);
                                const voices = synth.getVoices();
                                const indianVoice = voices.find(v => v.lang.includes('IN'));
                                if(indianVoice) utterance.voice = indianVoice;
                                synth.cancel();
                                synth.speak(utterance);
                            }
                        }, 500);
                    }
                });
            });
        });
        setTimeout(() => {
            const chatContainer = document.querySelector('#n8n-chat');
            if(chatContainer) observer.observe(chatContainer, { childList: true, subtree: true });
        }, 2000);


        // 2. SPEECH-TO-TEXT (You Speak)
        const micBtn = document.getElementById('mic-btn');
        
        if ('webkitSpeechRecognition' in window) {
            const recognition = new webkitSpeechRecognition();
            recognition.continuous = false;
            recognition.lang = 'en-IN'; 
            recognition.interimResults = false;

            micBtn.addEventListener('click', () => {
                recognition.start();
                micBtn.classList.add('listening');
            });

            recognition.onresult = (event) => {
                micBtn.classList.remove('listening');
                const transcript = event.results[0][0].transcript;
                console.log("You said:", transcript); // Debugging line

                // --- SMART FINDER LOGIC ---
                // We try multiple ways to find the input box inside the n8n widget
                const chatInput = document.querySelector('textarea') || 
                                  document.querySelector('input[type="text"]');
                
                if (chatInput) {
                    // Force the value into the box
                    chatInput.value = transcript;
                    chatInput.dispatchEvent(new Event('input', { bubbles: true }));
                    chatInput.dispatchEvent(new Event('change', { bubbles: true }));

                    // Try to find the send button and click it
                    setTimeout(() => {
                        const sendBtn = document.querySelector('button[class*="chat-input-send"]') || 
                                        document.querySelector('button[aria-label="Send message"]');
                        if (sendBtn) {
                            sendBtn.click();
                        } else {
                            // If button not found, try hitting "Enter" key programmatically
                            chatInput.dispatchEvent(new KeyboardEvent('keydown', { key: 'Enter', bubbles: true }));
                        }
                    }, 200);
                } else {
                    alert("Error: Could not find the chat box. Please type manually.");
                }
            };

            recognition.onerror = (e) => {
                micBtn.classList.remove('listening');
                console.error("Speech error:", e);
            };
            
            recognition.onend = () => {
                micBtn.classList.remove('listening');
            };
        } else {
            micBtn.style.display = 'none';
        }
    </script>
</body>
</html>
